<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Pipeline Visual Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        h1, h2, h3 { text-align: center; }
        /* Cytoscape container takes up full width and 70% of viewport height */
        #cytoscape {
            width: 100%;
            height: 70vh;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        /* Flex container for editor form and pipeline list */
        .editor-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 2rem;
            padding: 1rem;
        }
        .editor-form {
            flex: 1;
            max-width: 400px;
        }
        .existing-pipelines {
            flex: 0 0 300px;
            align-self: flex-start;
        }
        /* Tighter form rows: label and input on the same line */
        .form-row {
            display: flex;
            align-items: center;
            margin: 0.5rem 0;
        }
        .form-row label {
            width: 150px;
            margin-right: 0.5rem;
            text-align: right;
            font-weight: normal;
        }
        .form-row input {
            flex: 1;
            padding: 5px;
            font-size: 14px;
        }
        .form-row.buttons {
            justify-content: center;
        }
        .form-row.buttons button {
            margin: 0 0.5rem;
            padding: 8px 16px;
            font-size: 14px;
        }
        /* Pipeline list styles */
        .pipeline-list {
            border: 1px solid #ccc;
            padding: 10px;
        }
        .pipeline-list h3 {
            margin-top: 0;
        }
        .pipeline-list ul {
            list-style: none;
            padding: 0;
        }
        .pipeline-list li {
            margin-bottom: 10px;
        }
        .pipeline-list a {
            cursor: pointer;
            color: #1a73e8;
            text-decoration: none;
        }
        .pipeline-list a:hover {
            text-decoration: underline;
        }
        .services-list {
            margin-left: 10px;
            font-size: 90%;
            color: #555;
        }
    </style>

    <!-- Include Cytoscape, panzoom, and Mermaid -->
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/cytoscape-panzoom/cytoscape-panzoom.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <script th:inline="javascript">
        /*
           The controller now supplies:
             - pipelineConfig: the active pipelineâ€™s service map.
             - pipelineNames: a set of pipeline names.
             - activePipeline: the name of the active pipeline.
             - pipelines: a map from pipeline name to its full service map.
        */
        let pipelineConfig = [[${pipelineConfig}]];
        let pipelineNames = [[${pipelineNames}]];
        let activePipeline = '[[${activePipeline}]]';
        let allPipelines = [[${pipelines}]];

        // Helper function: generate a unique node ID by replacing non-word characters.
        const nodeId = (type, name) => type + '_' + name.replace(/\W/g, '_');

        // Generate Mermaid DSL from the active pipeline configuration.
        function generateMermaidDSL() {
            let graph = 'graph TD\n';
            let grpcNodes = new Set();
            let kafkaNodes = new Set();
            for (let [service, cfg] of Object.entries(pipelineConfig)) {
                const grpcNode = nodeId('grpc', service);
                if (!grpcNodes.has(grpcNode)) {
                    graph += `${grpcNode}([${service}])\n`;
                    grpcNodes.add(grpcNode);
                }
                (cfg.kafkaListenTopics || []).forEach(topic => {
                    const kafkaNode = nodeId('kafka', topic);
                    kafkaNodes.add(kafkaNode);
                    graph += `${kafkaNode}[${topic}]\n`;
                    graph += `${kafkaNode} --> ${grpcNode}\n`;
                });
                (cfg.kafkaPublishTopics || []).forEach(topic => {
                    const kafkaNode = nodeId('kafka', topic);
                    kafkaNodes.add(kafkaNode);
                    graph += `${grpcNode} --> ${kafkaNode}\n`;
                });
                (cfg.grpcForwardTo || []).forEach(target => {
                    if (target && target.toLowerCase() !== 'null') {
                        const targetNode = nodeId('grpc', target);
                        if (!grpcNodes.has(targetNode)) {
                            graph += `${targetNode}([${target}])\n`;
                            grpcNodes.add(targetNode);
                        }
                        graph += `${grpcNode} --> ${targetNode}\n`;
                    }
                });
            }
            grpcNodes.forEach(id => {
                graph += `style ${id} fill:#ADD8E6,stroke:#333,color:#000\n`;
            });
            kafkaNodes.forEach(id => {
                graph += `style ${id} fill:#FFA500,stroke:#333,color:#000\n`;
            });
            return graph;
        }

        function copyMermaidToClipboard() {
            const dsl = generateMermaidDSL();
            navigator.clipboard.writeText(dsl).then(() => {
                alert('Mermaid DSL copied to clipboard!');
            }, err => {
                console.error('Failed to copy text: ', err);
            });
        }

        // Global function: load service data from active pipeline config into the form.
        function selectService(serviceName) {
            const cfg = pipelineConfig[serviceName];
            if (!cfg) return;
            document.getElementById('service-name').value = serviceName;
            document.getElementById('kafka-listen').value = (cfg.kafkaListenTopics || []).join(", ");
            document.getElementById('kafka-publish').value = (cfg.kafkaPublishTopics || []).join(", ");
            document.getElementById('grpc-forward').value = (cfg.grpcForwardTo || []).join(", ");
        }
        window.selectService = selectService;

        // Render the Cytoscape graph for the active pipeline.
        function renderCytoscape() {
            const elements = [];
            for (let [service, cfg] of Object.entries(pipelineConfig)) {
                const grpcNode = nodeId('grpc', service);
                elements.push({ data: { id: grpcNode, label: service, type: 'grpc', original: service } });
                (cfg.kafkaListenTopics || []).forEach(topic => {
                    const kafkaNode = nodeId('kafka', topic);
                    if (!elements.find(e => e.data.id === kafkaNode)) {
                        elements.push({ data: { id: kafkaNode, label: topic, type: 'kafka' } });
                    }
                    elements.push({ data: { id: kafkaNode + '_to_' + grpcNode, source: kafkaNode, target: grpcNode } });
                });
                (cfg.kafkaPublishTopics || []).forEach(topic => {
                    const kafkaNode = nodeId('kafka', topic);
                    if (!elements.find(e => e.data.id === kafkaNode)) {
                        elements.push({ data: { id: kafkaNode, label: topic, type: 'kafka' } });
                    }
                    elements.push({ data: { id: grpcNode + '_to_' + kafkaNode, source: grpcNode, target: kafkaNode } });
                });
                (cfg.grpcForwardTo || []).forEach(target => {
                    if (target && target.toLowerCase() !== 'null') {
                        const targetNode = nodeId('grpc', target);
                        if (!elements.find(e => e.data.id === targetNode)) {
                            elements.push({ data: { id: targetNode, label: target, type: 'grpc', original: target } });
                        }
                        elements.push({ data: { id: grpcNode + '_to_' + targetNode, source: grpcNode, target: targetNode } });
                    }
                });
            }

            let cy = cytoscape({
                container: document.getElementById('cytoscape'),
                elements: elements,
                style: [
                    {
                        selector: 'node[type="grpc"]',
                        style: {
                            'background-color': '#ADD8E6',
                            'label': 'data(label)',
                            'shape': 'ellipse',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'color': '#000',
                            'font-size': '12px',
                            'font-weight': 'normal',
                            'width': '80px',
                            'height': '80px',
                            'text-wrap': 'wrap',
                            'text-max-width': '70px',
                            'padding': '5px'
                        }
                    },
                    {
                        selector: 'node[type="kafka"]',
                        style: {
                            'background-color': '#FFA500',
                            'label': 'data(label)',
                            'shape': 'rectangle',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'color': '#000',
                            'font-size': '12px',
                            'font-weight': 'normal',
                            'width': '100px',
                            'height': '50px',
                            'text-wrap': 'wrap',
                            'text-max-width': '90px',
                            'padding': '5px'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#ccc',
                            'target-arrow-color': '#ccc',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier'
                        }
                    }
                ],
                layout: {
                    name: 'breadthfirst',
                    directed: true,
                    padding: 50,
                    spacingFactor: 1.2,
                    animate: true,
                    orientation: 'vertical'
                }
            });

            if (typeof cytoscapePanzoom !== 'undefined') {
                cytoscape.use(cytoscapePanzoom);
                cy.panzoom();
            }

            cy.on('tap', 'node[type="grpc"]', function(evt) {
                let node = evt.target;
                let serviceName = node.data('original');
                if (serviceName) {
                    selectService(serviceName);
                }
            });

            cy.fit();
        }

        function renderExistingPipelines() {
            const listContainer = document.querySelector('.existing-pipelines ul');
            let html = '';
            Object.values(pipelineNames).forEach(name => {
                const selected = (name === activePipeline) ? ' (active)' : '';
                html += `<li><a href="#" data-pipeline="${name}" onclick="selectPipeline(this.getAttribute('data-pipeline')); return false;">${name}${selected}</a></li>`;
            });
            listContainer.innerHTML = html;
        }

        // Called when the user selects a different pipeline.
        function selectPipeline(pipelineName) {
            // For now, simply reload the page with the selected pipeline.
            window.location.href = '/?pipeline=' + pipelineName;
        }

        // Save the updated service configuration and re-render the graph and pipeline list.
        async function saveService() {
            const payload = {
                name: document.getElementById('service-name').value,
                kafkaListenTopics: document.getElementById('kafka-listen').value.split(',').map(s => s.trim()).filter(Boolean),
                kafkaPublishTopics: document.getElementById('kafka-publish').value.split(',').map(s => s.trim()).filter(Boolean),
                grpcForwardTo: document.getElementById('grpc-forward').value.split(',').map(s => s.trim()).filter(Boolean)
            };

            await fetch('/pipeline/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const response = await fetch('/pipeline');
            pipelineConfig = await response.json();
            renderCytoscape();
            renderExistingPipelines();
        }

        document.addEventListener('DOMContentLoaded', function(){
            renderCytoscape();
            renderExistingPipelines();
        });
    </script>
</head>
<body>
<h1>Pipeline Visual Editor</h1>
<!-- Cytoscape graph container -->
<div id="cytoscape"></div>

<!-- Editor container: service editor form and pipeline list side by side -->
<div class="editor-container">
    <div class="editor-form">
        <h2>Service Editor</h2>
        <form onsubmit="saveService(); return false;">
            <div class="form-row">
                <label for="service-name">Service Name:</label>
                <input id="service-name" placeholder="service-name" required/>
            </div>
            <div class="form-row">
                <label for="kafka-listen">Kafka Listen Topics:</label>
                <input id="kafka-listen" placeholder="comma separated"/>
            </div>
            <div class="form-row">
                <label for="kafka-publish">Kafka Publish Topics:</label>
                <input id="kafka-publish" placeholder="comma separated"/>
            </div>
            <div class="form-row">
                <label for="grpc-forward">gRPC Forward To:</label>
                <input id="grpc-forward" placeholder="comma separated"/>
            </div>
            <div class="form-row buttons">
                <button type="submit">Save</button>
                <button type="button" onclick="copyMermaidToClipboard()" title="Copy Mermaid to clipboard">Copy Mermaid</button>
            </div>
        </form>
    </div>
    <div class="existing-pipelines">
        <h3>Pipeline Configurations</h3>
        <ul>
            <!-- This list will be rendered dynamically with pipeline names and their services -->
        </ul>
    </div>
</div>
</body>
</html>